{"ast":null,"code":"import { BehaviorSubject, tap } from 'rxjs';\nimport { jwtDecode } from 'jwt-decode'; // npm install jwt-decode\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./api.service\";\nimport * as i2 from \"@angular/router\";\nclass AuthService {\n  constructor(apiService, router) {\n    this.apiService = apiService;\n    this.router = router;\n    this.currentUserSubject = new BehaviorSubject(null);\n    this.currentUser$ = this.currentUserSubject.asObservable();\n    this.loadUserFromToken();\n  }\n  loadUserFromToken() {\n    const token = this.getToken();\n    if (token) {\n      try {\n        const decodedUser = jwtDecode(token);\n        // Check if token is expired\n        if (decodedUser.exp * 1000 > Date.now()) {\n          this.currentUserSubject.next(decodedUser);\n        } else {\n          this.logout(); // Token is expired, clear session\n        }\n      } catch (error) {\n        this.logout(); // Invalid token\n      }\n    }\n  }\n\n  login(credentials) {\n    return this.apiService.login(credentials).pipe(tap(response => {\n      localStorage.setItem('authToken', response.token);\n      const decodedUser = jwtDecode(response.token);\n      this.currentUserSubject.next(decodedUser);\n      this.router.navigate(['/requests']);\n    }));\n  }\n  logout() {\n    localStorage.removeItem('authToken');\n    this.currentUserSubject.next(null);\n    this.router.navigate(['/login']);\n  }\n  getToken() {\n    return localStorage.getItem('authToken');\n  }\n  static {\n    this.ɵfac = function AuthService_Factory(t) {\n      return new (t || AuthService)(i0.ɵɵinject(i1.ApiService), i0.ɵɵinject(i2.Router));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: AuthService,\n      factory: AuthService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}\nexport { AuthService };","map":{"version":3,"names":["BehaviorSubject","tap","jwtDecode","AuthService","constructor","apiService","router","currentUserSubject","currentUser$","asObservable","loadUserFromToken","token","getToken","decodedUser","exp","Date","now","next","logout","error","login","credentials","pipe","response","localStorage","setItem","navigate","removeItem","getItem","i0","ɵɵinject","i1","ApiService","i2","Router","factory","ɵfac","providedIn"],"sources":["/home/coder/case-workflow/frontend/src/app/services/auth.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { BehaviorSubject, Observable, tap } from 'rxjs';\nimport { jwtDecode } from 'jwt-decode'; // npm install jwt-decode\nimport { ApiService } from './api.service';\nimport { LoginRequest, LoginResponse } from '../models/api.models';\n\n// This interface represents the decoded user data from the JWT\nexport interface User {\n  userId: string;\n  name: string;\n  role: 'User' | 'Manager';\n  exp: number; // Expiration time (Unix timestamp)\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class AuthService {\n  private currentUserSubject = new BehaviorSubject<User | null>(null);\n  public currentUser$ = this.currentUserSubject.asObservable();\n\n  constructor(\n    private apiService: ApiService,\n    private router: Router\n  ) {\n    this.loadUserFromToken();\n  }\n\n  private loadUserFromToken(): void {\n    const token = this.getToken();\n    if (token) {\n      try {\n        const decodedUser = jwtDecode<User>(token);\n        // Check if token is expired\n        if (decodedUser.exp * 1000 > Date.now()) {\n          this.currentUserSubject.next(decodedUser);\n        } else {\n          this.logout(); // Token is expired, clear session\n        }\n      } catch (error) {\n        this.logout(); // Invalid token\n      }\n    }\n  }\n\n  login(credentials: LoginRequest): Observable<LoginResponse> {\n    return this.apiService.login(credentials).pipe(\n      tap(response => {\n        localStorage.setItem('authToken', response.token);\n        const decodedUser = jwtDecode<User>(response.token);\n        this.currentUserSubject.next(decodedUser);\n        this.router.navigate(['/requests']);\n      })\n    );\n  }\n\n  logout(): void {\n    localStorage.removeItem('authToken');\n    this.currentUserSubject.next(null);\n    this.router.navigate(['/login']);\n  }\n\n  public getToken(): string | null {\n    return localStorage.getItem('authToken');\n  }\n}"],"mappings":"AAEA,SAASA,eAAe,EAAcC,GAAG,QAAQ,MAAM;AACvD,SAASC,SAAS,QAAQ,YAAY,CAAC,CAAC;;;;AAYxC,MAGaC,WAAW;EAItBC,YACUC,UAAsB,EACtBC,MAAc;IADd,KAAAD,UAAU,GAAVA,UAAU;IACV,KAAAC,MAAM,GAANA,MAAM;IALR,KAAAC,kBAAkB,GAAG,IAAIP,eAAe,CAAc,IAAI,CAAC;IAC5D,KAAAQ,YAAY,GAAG,IAAI,CAACD,kBAAkB,CAACE,YAAY,EAAE;IAM1D,IAAI,CAACC,iBAAiB,EAAE;EAC1B;EAEQA,iBAAiBA,CAAA;IACvB,MAAMC,KAAK,GAAG,IAAI,CAACC,QAAQ,EAAE;IAC7B,IAAID,KAAK,EAAE;MACT,IAAI;QACF,MAAME,WAAW,GAAGX,SAAS,CAAOS,KAAK,CAAC;QAC1C;QACA,IAAIE,WAAW,CAACC,GAAG,GAAG,IAAI,GAAGC,IAAI,CAACC,GAAG,EAAE,EAAE;UACvC,IAAI,CAACT,kBAAkB,CAACU,IAAI,CAACJ,WAAW,CAAC;SAC1C,MAAM;UACL,IAAI,CAACK,MAAM,EAAE,CAAC,CAAC;;OAElB,CAAC,OAAOC,KAAK,EAAE;QACd,IAAI,CAACD,MAAM,EAAE,CAAC,CAAC;;;EAGrB;;EAEAE,KAAKA,CAACC,WAAyB;IAC7B,OAAO,IAAI,CAAChB,UAAU,CAACe,KAAK,CAACC,WAAW,CAAC,CAACC,IAAI,CAC5CrB,GAAG,CAACsB,QAAQ,IAAG;MACbC,YAAY,CAACC,OAAO,CAAC,WAAW,EAAEF,QAAQ,CAACZ,KAAK,CAAC;MACjD,MAAME,WAAW,GAAGX,SAAS,CAAOqB,QAAQ,CAACZ,KAAK,CAAC;MACnD,IAAI,CAACJ,kBAAkB,CAACU,IAAI,CAACJ,WAAW,CAAC;MACzC,IAAI,CAACP,MAAM,CAACoB,QAAQ,CAAC,CAAC,WAAW,CAAC,CAAC;IACrC,CAAC,CAAC,CACH;EACH;EAEAR,MAAMA,CAAA;IACJM,YAAY,CAACG,UAAU,CAAC,WAAW,CAAC;IACpC,IAAI,CAACpB,kBAAkB,CAACU,IAAI,CAAC,IAAI,CAAC;IAClC,IAAI,CAACX,MAAM,CAACoB,QAAQ,CAAC,CAAC,QAAQ,CAAC,CAAC;EAClC;EAEOd,QAAQA,CAAA;IACb,OAAOY,YAAY,CAACI,OAAO,CAAC,WAAW,CAAC;EAC1C;;;uBA/CWzB,WAAW,EAAA0B,EAAA,CAAAC,QAAA,CAAAC,EAAA,CAAAC,UAAA,GAAAH,EAAA,CAAAC,QAAA,CAAAG,EAAA,CAAAC,MAAA;IAAA;EAAA;;;aAAX/B,WAAW;MAAAgC,OAAA,EAAXhC,WAAW,CAAAiC,IAAA;MAAAC,UAAA,EAFV;IAAM;EAAA;;SAEPlC,WAAW","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}